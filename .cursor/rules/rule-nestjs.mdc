---
alwaysApply: true
---

ğŸ” Cursor AI â€“ NestJS Backend Rules (TÆ°Æ¡ng thÃ­ch vá»›i SFT Dataset FE)

## 1. NguyÃªn táº¯c cá»‘t lÃµi

NestJS backend pháº£i TUYá»†T Äá»I tÆ°Æ¡ng thÃ­ch vá»›i Frontend React hiá»‡n táº¡i.

Má»i API response pháº£i match 100% vá»›i TypeScript interfaces trong `frontend/types.ts`.

Backend lÃ  trung gian giá»¯a FE vÃ  cÃ¡c service (Tika, Ollama), KHÃ”NG thay Ä‘á»•i logic business cá»§a FE.

## 2. Kiáº¿n trÃºc & Cáº¥u trÃºc

### 2.1. Cáº¥u trÃºc thÆ° má»¥c (Báº®T BUá»˜C)

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts                    # Entry point
â”‚   â”œâ”€â”€ app.module.ts              # Root module
â”‚   â”‚
â”‚   â”œâ”€â”€ upload/                    # Upload module
â”‚   â”‚   â”œâ”€â”€ upload.controller.ts   # API endpoints
â”‚   â”‚   â”œâ”€â”€ upload.service.ts      # Business logic
â”‚   â”‚   â”œâ”€â”€ upload.module.ts
â”‚   â”‚   â””â”€â”€ dto/                   # Data Transfer Objects
â”‚   â”‚       â”œâ”€â”€ upload-file.dto.ts
â”‚   â”‚       â””â”€â”€ process-response.dto.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ documents/                 # Documents module (nhiá»‡m vá»¥ 2)
â”‚   â”‚   â”œâ”€â”€ documents.controller.ts
â”‚   â”‚   â”œâ”€â”€ documents.service.ts
â”‚   â”‚   â””â”€â”€ documents.module.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                  # External services
â”‚   â”‚   â”œâ”€â”€ tika.service.ts        # Tika integration
â”‚   â”‚   â””â”€â”€ ollama.service.ts      # Ollama integration
â”‚   â”‚
â”‚   â””â”€â”€ common/                    # Shared utilities
â”‚       â”œâ”€â”€ interfaces/            # TypeScript interfaces
â”‚       â”‚   â””â”€â”€ frontend-types.ts  # Copy tá»« FE types.ts
â”‚       â””â”€â”€ filters/               # Exception filters
â”‚           â””â”€â”€ http-exception.filter.ts
â”‚
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ .env
```

### 2.2. Module Pattern (Báº®T BUá»˜C)

- Má»—i feature = 1 module (Upload, Documents, ...)
- Service layer xá»­ lÃ½ business logic
- Controller chá»‰ handle HTTP requests/responses
- DTOs validate input/output
- External services (Tika, Ollama) tÃ¡ch riÃªng trong `services/`

## 3. API Contract vá»›i Frontend (Báº®T BUá»˜C)

### 3.1. Data Types pháº£i match 100%

Backend DTOs pháº£i match chÃ­nh xÃ¡c vá»›i FE types:

```typescript
// Pháº£i copy tá»« frontend/types.ts
export interface Document {
  id: string;
  name: string;
  size: string;
  uploadDate: string;
  totalSamples: number;
  reviewedSamples: number;
  status: 'Ready' | 'Processing' | 'Failed';
}

export interface QAPair {
  id: string;
  docId: string;
  question: string;
  answer: string;
  status: 'Pending' | 'Reviewed' | 'Edited';
  originalQuestion?: string;
  originalAnswer?: string;
}

export interface GeneratedQA {
  question: string;
  answer: string;
}
```

### 3.2. API Endpoints (Báº®T BUá»˜C)

#### POST /api/upload/process
**Request:**
- Content-Type: `multipart/form-data`
- Body:
  - `file`: File (PDF/DOCX)
  - `autoGenerate`: boolean (optional, default: true)
  - `count`: number (optional, default: 5) - Sá»‘ lÆ°á»£ng Q&A pairs

**Response:**
```typescript
{
  fileName: string;
  fileSize: string;
  qaPairs: GeneratedQA[];  // Format: [{question: string, answer: string}]
}
```

**Error Response:**
```typescript
{
  statusCode: number;
  message: string;
  error?: string;
}
```

#### GET /api/health
**Response:**
```typescript
{
  status: 'ok';
  services: {
    tika: 'ok' | 'error';
    ollama: 'ok' | 'error';
  };
}
```

### 3.3. CORS Configuration (Báº®T BUá»˜C)

```typescript
// main.ts
app.enableCors({
  origin: 'http://localhost:3000', // Vite dev server
  credentials: true,
});
```

## 4. NestJS Best Practices

### 4.1. Dependency Injection (Báº®T BUá»˜C)

- LuÃ´n dÃ¹ng constructor injection
- Services pháº£i Ä‘Æ°á»£c inject vÃ o controllers
- External services (Tika, Ollama) inject vÃ o business services

```typescript
// âœ… ÄÃšNG
@Injectable()
export class UploadService {
  constructor(
    private readonly tikaService: TikaService,
    private readonly ollamaService: OllamaService,
  ) {}
}

// âŒ SAI - KhÃ´ng dÃ¹ng new TikaService()
```

### 4.2. File Upload (Báº®T BUá»˜C)

- DÃ¹ng `@UseInterceptors(FileInterceptor('file'))` tá»« `@nestjs/platform-express`
- Validate file type: chá»‰ PDF, DOCX
- Validate file size: max 50MB
- Return error rÃµ rÃ ng náº¿u validation fail

```typescript
@Post('process')
@UseInterceptors(FileInterceptor('file'))
async processFile(
  @UploadedFile() file: Express.Multer.File,
  @Body() body: { autoGenerate?: boolean; count?: number },
) {
  // Validate file
  // Process vá»›i Tika + Ollama
  // Return response
}
```

### 4.3. Error Handling (Báº®T BUá»˜C)

- DÃ¹ng `HttpException` hoáº·c custom exceptions
- Táº¡o Exception Filter Ä‘á»ƒ format error response chuáº©n
- Log errors nhÆ°ng khÃ´ng expose internal details ra FE

```typescript
// âœ… ÄÃšNG
throw new BadRequestException('File khÃ´ng há»£p lá»‡. Chá»‰ cháº¥p nháº­n PDF hoáº·c DOCX.');

// âŒ SAI - KhÃ´ng expose internal error
throw new Error('Tika connection failed: ECONNREFUSED');
```

### 4.4. Async/Await (Báº®T BUá»˜C)

- LuÃ´n dÃ¹ng async/await, khÃ´ng dÃ¹ng Promise.then()
- Handle errors vá»›i try-catch
- Return proper HTTP status codes

### 4.5. Validation (Báº®T BUá»˜C)

- DÃ¹ng `class-validator` cho DTOs
- Validate input trÆ°á»›c khi xá»­ lÃ½
- Return 400 Bad Request náº¿u validation fail

```typescript
export class ProcessFileDto {
  @IsOptional()
  @IsBoolean()
  autoGenerate?: boolean;

  @IsOptional()
  @IsNumber()
  @Min(1)
  @Max(20)
  count?: number;
}
```

## 5. Integration vá»›i External Services

### 5.1. Tika Service (Báº®T BUá»˜C)

- Endpoint: `http://localhost:9998/tika`
- Method: PUT
- Headers: `Accept: text/plain`, `Content-Type: application/octet-stream`
- Body: File binary
- Return: Plain text string
- Error handling: Throw `HttpException` vá»›i message rÃµ rÃ ng

### 5.2. Ollama Service (Báº®T BUá»˜C)

- Endpoint: `http://localhost:11434/api/generate`
- Method: POST
- Model: `llama3` (cÃ³ thá»ƒ config qua env)
- Request body:
  ```typescript
  {
    model: string;
    prompt: string;
    stream: false;
    format: 'json';
  }
  ```
- Response parsing: Parse JSON tá»« `response.response`
- Error handling: Throw `HttpException` vá»›i message rÃµ rÃ ng

### 5.3. Service Layer Pattern

```typescript
@Injectable()
export class TikaService {
  private readonly tikaEndpoint = 'http://localhost:9998/tika';

  async extractText(file: Buffer): Promise<string> {
    // Implementation
  }
}

@Injectable()
export class OllamaService {
  private readonly ollamaEndpoint = 'http://localhost:11434/api/generate';
  private readonly defaultModel = 'llama3';

  async generateQAPairs(text: string, count: number): Promise<GeneratedQA[]> {
    // Implementation
  }
}
```

## 6. Environment Configuration

### 6.1. .env File (Báº®T BUá»˜C)

```env
PORT=3001
TIKA_ENDPOINT=http://localhost:9998/tika
OLLAMA_ENDPOINT=http://localhost:11434/api/generate
OLLAMA_MODEL=llama3
```

### 6.2. Config Module (Khuyáº¿n nghá»‹)

- DÃ¹ng `@nestjs/config` Ä‘á»ƒ load env variables
- Validate env variables khi start
- Type-safe config vá»›i interfaces

## 7. Testing Requirements

### 7.1. Unit Tests (Khuyáº¿n nghá»‹)

- Test services vá»›i mocked dependencies
- Test error cases
- Test validation logic

### 7.2. Integration Tests (Khuyáº¿n nghá»‹)

- Test API endpoints vá»›i test client
- Test vá»›i mock Tika/Ollama responses
- Test error scenarios

## 8. Code Quality Rules

### 8.1. TypeScript (Báº®T BUá»˜C)

- Strict mode: `true`
- No `any` types (trá»« khi thá»±c sá»± cáº§n)
- DÃ¹ng interfaces cho data structures
- DÃ¹ng enums cho constants

### 8.2. Naming Conventions (Báº®T BUá»˜C)

- Controllers: `*.controller.ts`
- Services: `*.service.ts`
- Modules: `*.module.ts`
- DTOs: `*.dto.ts`
- Interfaces: `*.interface.ts` hoáº·c trong `common/interfaces/`

### 8.3. Comments (Báº®T BUá»˜C)

- Comment giáº£i thÃ­ch WHY, khÃ´ng chá»‰ HOW
- JSDoc cho public methods
- TODO comments náº¿u cÃ³

## 9. Quy trÃ¬nh Development

### 9.1. Khi táº¡o API má»›i (Báº®T BUá»˜C)

1. XÃ¡c Ä‘á»‹nh DTOs cáº§n thiáº¿t (match vá»›i FE types)
2. Táº¡o controller vá»›i proper decorators
3. Táº¡o service vá»›i business logic
4. Test vá»›i FE Ä‘á»ƒ Ä‘áº£m báº£o tÆ°Æ¡ng thÃ­ch
5. Document API náº¿u cáº§n

### 9.2. Khi sá»­a API hiá»‡n cÃ³ (Báº®T BUá»˜C)

1. Kiá»ƒm tra impact lÃªn FE
2. Äáº£m báº£o backward compatibility
3. Update DTOs náº¿u cáº§n
4. Test vá»›i FE

## 10. CÃ¡c Ä‘iá»u Cáº¤M (ABSOLUTE NO)

âŒ KHÃ”NG Ä‘Æ°á»£c:
- Thay Ä‘á»•i response format mÃ  khÃ´ng update FE
- ThÃªm fields má»›i vÃ o response mÃ  FE khÃ´ng expect
- DÃ¹ng different naming convention vá»›i FE
- Expose internal errors ra FE
- Hardcode endpoints (pháº£i dÃ¹ng env)
- Bypass validation
- DÃ¹ng `any` type khÃ´ng cáº§n thiáº¿t
- Táº¡o circular dependencies giá»¯a modules

## 11. TÆ°Æ¡ng thÃ­ch vá»›i Frontend

### 11.1. Response Format (Báº®T BUá»˜C)

Má»i response pháº£i match chÃ­nh xÃ¡c vá»›i FE expectations:

- Success: Return data object
- Error: Return `{ statusCode, message, error? }`
- Status codes: 200, 201, 400, 404, 500

### 11.2. Date Format (Báº®T BUá»˜C)

- DÃ¹ng format: `YYYY-MM-DD` hoáº·c `DD/MM/YYYY` (match vá»›i FE)
- KhÃ´ng dÃ¹ng ISO string náº¿u FE khÃ´ng expect

### 11.3. ID Format (Báº®T BUá»˜C)

- Document ID: `doc-${timestamp}` (match vá»›i FE)
- QA Pair ID: `qa-${docId}-${index}` (match vá»›i FE)

## 12. Performance & Security

### 12.1. File Upload (Báº®T BUá»˜C)

- Limit file size: 50MB
- Validate MIME type
- Stream processing náº¿u file lá»›n
- Cleanup temp files sau khi xá»­ lÃ½

### 12.2. Rate Limiting (Khuyáº¿n nghá»‹)

- Implement rate limiting cho upload endpoint
- Prevent abuse

### 12.3. Logging (Báº®T BUá»˜C)

- Log errors vá»›i context
- Log API requests (khÃ´ng log sensitive data)
- DÃ¹ng structured logging

## 13. Deployment Notes

- Port: 3001 (khÃ´ng conflict vá»›i FE port 3000)
- Health check endpoint: `/api/health`
- Graceful shutdown
- Environment-based configuration

---

**LÆ°u Ã½ cuá»‘i cÃ¹ng:**

Backend NestJS lÃ  SERVICE LAYER cho FE, khÃ´ng pháº£i standalone application.

Má»i quyáº¿t Ä‘á»‹nh pháº£i Ä‘áº·t tÆ°Æ¡ng thÃ­ch vá»›i FE lÃªn hÃ ng Ä‘áº§u.

Náº¿u cÃ³ conflict giá»¯a "best practice" vÃ  "tÆ°Æ¡ng thÃ­ch vá»›i FE", chá»n tÆ°Æ¡ng thÃ­ch vá»›i FE.
